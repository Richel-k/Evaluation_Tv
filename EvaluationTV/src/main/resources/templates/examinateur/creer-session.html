<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©er une Nouvelle Session</title>
    <link rel="stylesheet" th:href="@{/css/Home.css}">
</head>

<body>
    <!-- Menu Toggle -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <span class="hamburger-icon">‚ò∞</span>
    </button>

    <!-- Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar examinateur-sidebar" id="sidebar">
        <h2>üë®‚Äçüè´ Examinateur</h2>
        <a th:href="@{/examinateur/dashboard}">üè† Dashboard</a>
        <a th:href="@{/examinateur/update-session}">üìù Mes Sessions</a>
        <a class="active" th:href="@{/examinateur/creer-session}">‚ûï Cr√©er Session</a>
        <a href="#stats">üìä Statistiques</a>
        <a href="/logout" class="logout">üö™ D√©connexion</a>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="content-wrapper">
            <!-- Header -->
            <div class="page-header">
                <h1 class="page-title">‚ûï Cr√©er une Nouvelle Session</h1>
                <p class="page-subtitle">Cr√©ez une session d'√©valuation personnalis√©e pour vos candidats</p>
            </div>

            <!-- Form Container -->
            <div class="form-container">
                <!-- Informations de Base -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h3>üìã Informations G√©n√©rales</h3>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="session-title">Titre de la Session</label>
                            <input type="text" id="session-title" placeholder="Ex: Examen de Programmation Java Avanc√©e"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="session-description">Description</label>
                            <textarea id="session-description" rows="3"
                                placeholder="Description d√©taill√©e de l'√©valuation..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="session-date">Date de la Session</label>
                            <input type="date" id="session-date" required>
                        </div>

                        <div class="form-group">
                            <label for="session-time">Heure de D√©but</label>
                            <input type="time" id="session-time" required>
                        </div>

                        <div class="form-group">
                            <label for="session-duration">Dur√©e (minutes)</label>
                            <input type="number" id="session-duration" min="1" max="300" value="60" required>
                        </div>

                        <div class="form-group">
                            <label for="session-max-candidates">Nombre maximum de candidats</label>
                            <input type="number" id="session-max-candidates" min="1" max="500" value="50">
                        </div>
                    </div>
                </div>

                <!-- Param√®tres d'√âvaluation -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h3>‚öôÔ∏è Param√®tres d'√âvaluation</h3>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="passing-score">Score de R√©ussite (%)</label>
                            <input type="number" id="passing-score" min="0" max="100" value="60">
                        </div>

                        <div class="form-group">
                            <label for="question-order">Ordre des Questions</label>
                            <select id="question-order">
                                <option value="random">Al√©atoire</option>
                                <option value="sequential">S√©quentiel</option>
                                <option value="difficulty">Par difficult√© croissante</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="result-visibility">Visibilit√© des R√©sultats</label>
                            <select id="result-visibility">
                                <option value="immediate">Imm√©diate apr√®s soumission</option>
                                <option value="after-session">Apr√®s la session</option>
                                <option value="manual">Manuelle (par l'examinateur)</option>
                            </select>
                        </div>

                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="allow-backtracking" checked>
                            <label for="allow-backtracking">Autoriser le retour aux questions pr√©c√©dentes</label>
                        </div>

                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="shuffle-answers">
                            <label for="shuffle-answers">M√©langer les r√©ponses</label>
                        </div>

                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="time-per-question">
                            <label for="time-per-question">Temps limit√© par question</label>
                        </div>
                    </div>
                </div>

                <!-- Gestion des Questions -->
                <div class="form-section">
                    <div class="form-section-header">
                        <div class="header-with-action">
                            <h3>‚ùì Gestion des Questions</h3>
                            <button type="button" class="btn-primary btn-small" onclick="addQuestion()">
                                ‚ûï Ajouter une Question
                            </button>
                        </div>
                    </div>

                    <!-- Questions Container -->
                    <div class="questions-container" id="questions-container">
                        <!-- Question 1 -->
                        <div class="question-item" id="question-1">
                            <div class="question-header">
                                <span class="question-number">Question 1</span>
                                <button type="button" class="btn-danger btn-small" onclick="removeQuestion(1)">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>

                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label>√ânonc√© de la Question</label>
                                    <textarea class="question-text"
                                        placeholder="Entrez l'√©nonc√© de la question..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label>Type de Question</label>
                                    <select class="question-type">
                                        <option value="multiple">Choix multiple</option>
                                        <option value="single">Choix unique</option>
                                        <option value="truefalse">Vrai/Faux</option>
                                        <option value="text">R√©ponse texte</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Points</label>
                                    <input type="number" class="question-points" min="0" value="1">
                                </div>

                                <div class="form-group">
                                    <label>Dur√©e - Question</label>
                                    <input type="time" name="duree-question" class="question-duration">
                                    <!-- <select class="question-difficulty">
                                        <option value="easy">Facile</option>
                                        <option value="medium" selected>Moyenne</option>
                                        <option value="hard">Difficile</option>
                                    </select> -->
                                </div>
                            </div>

                            <!-- R√©ponses (visible pour choix multiple/unique) -->
                            <div class="answers-section" id="answers-1">
                                <div class="answers-header">
                                    <label>R√©ponses</label>
                                    <button type="button" class="btn-secondary btn-small" onclick="addAnswer(1)">
                                        ‚ûï Ajouter R√©ponse
                                    </button>
                                </div>

                                <div class="answers-list">
                                    <div class="answer-item">
                                        <div class="answer-content">
                                            <input type="checkbox" class="answer-correct">
                                            <input type="text" class="answer-text" placeholder="Texte de la r√©ponse...">
                                        </div>
                                        <button type="button" class="btn-danger btn-tiny" onclick="removeAnswer(this)">
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="window.location.href='dashboard.html'">
                        ‚Üê Retour
                    </button>
                    <button type="button" class="btn-danger" onclick="resetForm()">
                        üîÑ R√©initialiser
                    </button>
                    <button type="submit" class="btn-primary" onclick="createSession()">
                        ‚úÖ Cr√©er la Session
                    </button>
                    <button type="button" class="btn-primary" onclick="saveDraft()">
                        üíæ Sauvegarder comme brouillon
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let questionCounter = 1;

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function addQuestion() {
            questionCounter++;
            const questionsContainer = document.getElementById('questions-container');

            const questionHTML = `
                <div class="question-item" id="question-${questionCounter}">
                    <div class="question-header">
                        <span class="question-number">Question ${questionCounter}</span>
                        <button type="button" class="btn-danger btn-small" onclick="removeQuestion(${questionCounter})">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>√ânonc√© de la Question</label>
                            <textarea class="question-text" placeholder="Entrez l'√©nonc√© de la question..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Type de Question</label>
                                <select class="question-type">
                                    <option value="multiple">Choix multiple</option>
                                    <option value="single">Choix unique</option>
                                    <option value="truefalse">Vrai/Faux</option>
                                    <option value="text">R√©ponse texte</option>
                                </select>
                        </div>

                        <div class="form-group">
                            <label>Points</label>
                            <input type="number" class="question-points" min="0" value="1">
                        </div>

                        <div class="form-group">
                            <label>Dur√©e - Question</label>
                            <input type="time" name="duree-question" class="question-duration">
                        </div>
                    </div>

                    <div class="answers-section" id="answers-${questionCounter}">
                        <div class="answers-header">
                            <label>R√©ponses</label>
                            <button type="button" class="btn-secondary btn-small" onclick="addAnswer(${questionCounter})">
                                ‚ûï Ajouter R√©ponse
                            </button>
                        </div>
                        
                        <div class="answers-list">
                            <div class="answer-item">
                                <div class="answer-content">
                                    <input type="checkbox" class="answer-correct">
                                    <input type="text" class="answer-text" placeholder="Texte de la r√©ponse...">
                                </div>
                                <button type="button" class="btn-danger btn-tiny" onclick="removeAnswer(this)">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
        }

        function removeQuestion(id) {
            const question = document.getElementById(`question-${id}`);
            if (question) {
                question.remove();
            }
        }

        function addAnswer(questionId) {
            const answersList = document.querySelector(`#answers-${questionId} .answers-list`);
            const answerHTML = `
                <div class="answer-item">
                    <div class="answer-content">
                        <input type="checkbox" class="answer-correct">
                        <input type="text" class="answer-text" placeholder="Texte de la r√©ponse...">
                    </div>
                    <button type="button" class="btn-danger btn-tiny" onclick="removeAnswer(this)">
                        ‚úï
                    </button>
                </div>
            `;
            answersList.insertAdjacentHTML('beforeend', answerHTML);
        }

        function removeAnswer(button) {
            button.parentElement.remove();
        }

        function toggleAnswersSection(questionId) {
            const select = document.querySelector(`#question-${questionId} .question-type`);
            const answersSection = document.getElementById(`answers-${questionId}`);

            if (select.value === 'text') {
                answersSection.style.display = 'none';
            } else {
                answersSection.style.display = 'block';
            }
        }

        function resetForm() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser le formulaire ? Toutes les donn√©es seront perdues.')) {
                document.querySelector('.form-container').reset();
                document.getElementById('questions-container').innerHTML = '';
                questionCounter = 0;
                addQuestion();
            }
        }






        function saveDraft() {
            alert('Brouillon sauvegard√© !');
        }













        async function createSession() {
            // Validation des champs obligatoires
            const title = document.getElementById('session-title').value;
            if (!title) {
                alert('Veuillez saisir un titre pour la session.');
                return;
            }

            // Collecte des donn√©es de la session
            const sessionData = {
                titre: title,
                description: document.getElementById('session-description').value,
                dateSession: document.getElementById('session-date').value,
                heureDebut: document.getElementById('session-time').value,
                dureeMinutes: parseInt(document.getElementById('session-duration').value),
                //nombreMaxCandidats: parseInt(document.getElementById('session-max-candidates').value) || 60, //Test de cre√©taions sessions
                scoreReussite: parseInt(document.getElementById('passing-score').value) || 60,
                ordreQuestions: document.getElementById('question-order').value,
                visibiliteResultats: document.getElementById('result-visibility').value,
                retourArriereAutorise: document.getElementById('allow-backtracking').checked,
                melangerReponses: document.getElementById('shuffle-answers').checked,
                tempsParQuestion: document.getElementById('time-per-question').checked,
                questions: collectQuestions()
            };

            // V√©rification qu'il y a au moins une question
            if (sessionData.questions.length === 0) {
                alert('Veuillez ajouter au moins une question √† la session.');
                return;
            }

            // V√©rification des r√©ponses pour les questions √† choix
            if (!validateQuestions(sessionData.questions)) {
                return;
            }

            try {
                // Afficher un indicateur de chargement
                showLoading();

                // Envoi des donn√©es au backend Spring Boot
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Ajouter le token d'authentification si n√©cessaire
                        // 'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(sessionData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erreur lors de la cr√©ation de la session');
                }

                const result = await response.json();

                // Afficher le message de succ√®s
                hideLoading();
                alert(`Session "${result.titre}" cr√©√©e avec succ√®s avec le code : ${result.codeSession}`);

                // Redirection vers le dashboard ou les d√©tails de la session
                window.location.href = `/examinateur/dashboard`;

            } catch (error) {
                hideLoading();
                console.error('Erreur:', error);
                alert(`Erreur: ${error.message}`);
            }
        }

        function collectQuestions() {
            const questions = [];
            const questionItems = document.querySelectorAll('.question-item');

            questionItems.forEach((questionItem, index) => {
                const question = {
                    numero: index + 1,
                    enonce: questionItem.querySelector('.question-text').value,
                    typeQuestion: questionItem.querySelector('.question-type').value,
                    points: parseFloat(questionItem.querySelector('.question-points').value) || 1,
                    time: questionItem.querySelector('.question-duration').value,
                    reponses: collectReponses(questionItem)
                };

                questions.push(question);
            });

            return questions;
        }

        function collectReponses(questionItem) {
            const reponses = [];
            const answerItems = questionItem.querySelectorAll('.answer-item');

            // Pour les questions texte, pas de r√©ponses pr√©d√©finies
            const questionType = questionItem.querySelector('.question-type').value;
            if (questionType === 'text') {
                return reponses;
            }

            answerItems.forEach((answerItem, index) => {
                const reponse = {
                    texte: answerItem.querySelector('.answer-text').value,
                    correcte: answerItem.querySelector('.answer-correct').checked,
                    ordre: index + 1
                };

                reponses.push(reponse);
            });

            return reponses;
        }

        function validateQuestions(questions) {
            for (const question of questions) {
                // Validation de l'√©nonc√©
                if (!question.enonce || question.enonce.trim() === '') {
                    alert(`La question ${question.numero} doit avoir un √©nonc√©.`);
                    return false;
                }

                // Validation des points
                if (question.points <= 0) {
                    alert(`La question ${question.numero} doit avoir un nombre de points positif.`);
                    return false;
                }

                // Validation des r√©ponses pour les questions √† choix
                if (question.typeQuestion !== 'text') {
                    if (question.reponses.length === 0) {
                        alert(`La question ${question.numero} doit avoir au moins une r√©ponse.`);
                        return false;
                    }

                    // Validation des textes de r√©ponse
                    for (const reponse of question.reponses) {
                        if (!reponse.texte || reponse.texte.trim() === '') {
                            alert(`La question ${question.numero} a une r√©ponse vide.`);
                            return false;
                        }
                    }

                    // Validation: au moins une r√©ponse correcte pour les questions √† choix
                    if (question.typeQuestion === 'single' || question.typeQuestion === 'multiple') {
                        const hasCorrectAnswer = question.reponses.some(r => r.correcte);
                        if (!hasCorrectAnswer) {
                            alert(`La question ${question.numero} doit avoir au moins une r√©ponse correcte.`);
                            return false;
                        }
                    }

                    // Validation: une seule r√©ponse correcte pour les questions √† choix unique
                    if (question.typeQuestion === 'single') {
                        const correctAnswers = question.reponses.filter(r => r.correcte);
                        if (correctAnswers.length > 1) {
                            alert(`La question ${question.numero} (choix unique) ne peut avoir qu'une seule r√©ponse correcte.`);
                            return false;
                        }
                    }
                }
            }

            return true;
        }

        function showLoading() {
            // Cr√©er ou afficher un overlay de chargement
            let loadingOverlay = document.getElementById('loading-overlay');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;

                const spinner = document.createElement('div');
                spinner.style.cssText = `
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        `;

                const text = document.createElement('p');
                text.textContent = 'Cr√©ation de la session en cours...';
                text.style.cssText = `
            margin-top: 20px;
            font-size: 16px;
            color: #3b82f6;
            font-weight: 600;
        `;

                loadingOverlay.appendChild(spinner);
                loadingOverlay.appendChild(text);
                document.body.appendChild(loadingOverlay);
            }

            loadingOverlay.style.display = 'flex';

            // Ajouter l'animation CSS si n√©cessaire
            if (!document.getElementById('loading-styles')) {
                const style = document.createElement('style');
                style.id = 'loading-styles';
                style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
                document.head.appendChild(style);
            }
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }
    </script>
</body>

</html>